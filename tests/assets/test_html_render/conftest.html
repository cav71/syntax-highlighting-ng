<div class="syntax-highlighting-ng">
<div class="highlight" style="background: #f8f8f8">
 <pre style="line-height: 125%;"><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"> 1</span><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">__future__</span> <span style="color: #008000; font-weight: bold">import</span> annotations
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"> 2</span><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"> 3</span><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">types</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"> 4</span><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">pathlib</span> <span style="color: #008000; font-weight: bold">import</span> Path
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"> 5</span><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">pytest</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"> 6</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"> 7</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"> 8</span><span style="color: #AA22FF">@pytest</span><span style="color: #666666">.</span>fixture(scope<span style="color: #666666">=</span><span style="color: #BA2121">"function"</span>)
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"> 9</span><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">assets</span>(request):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">10</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">11</span>    <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Asset</span>:
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">12</span>        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">13</span>            <span style="color: #008000">self</span><span style="color: #666666">.</span>basedir <span style="color: #666666">=</span> Path(<span style="color: #19177C">__file__</span>)<span style="color: #666666">.</span>parent
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">14</span>            <span style="color: #008000">self</span><span style="color: #666666">.</span>candidates <span style="color: #666666">=</span> [
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">15</span>                <span style="color: #BA2121">f"assets/</span><span style="color: #A45A77; font-weight: bold">{</span>request<span style="color: #666666">.</span>node<span style="color: #666666">.</span>module<span style="color: #666666">.</span><span style="color: #19177C">__name__</span><span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">"</span>,
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">16</span>                <span style="color: #BA2121">"assets"</span>,
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">17</span>            ]
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">18</span>        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">lookup</span>(<span style="color: #008000">self</span>, path: Path <span style="color: #666666">|</span> <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> Path<span style="color: #666666">|</span><span style="color: #008000; font-weight: bold">None</span>:
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">19</span>            <span style="color: #008000; font-weight: bold">for</span> candidate <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>candidates:
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">20</span>                <span style="color: #008000; font-weight: bold">if</span> (target <span style="color: #666666">:=</span> (<span style="color: #008000">self</span><span style="color: #666666">.</span>basedir <span style="color: #666666">/</span> candidate <span style="color: #666666">/</span> path))<span style="color: #666666">.</span>exists():
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">21</span>                    <span style="color: #008000; font-weight: bold">return</span> target
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">22</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">23</span>        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read_text</span>(<span style="color: #008000">self</span>, path: Path <span style="color: #666666">|</span> <span style="color: #008000">str</span>, fallback: <span style="color: #008000">str</span><span style="color: #666666">|</span><span style="color: #008000; font-weight: bold">None</span><span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span><span style="color: #666666">|</span><span style="color: #008000; font-weight: bold">None</span>:
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">24</span>            dest <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>lookup(path)
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">25</span>            <span style="color: #008000; font-weight: bold">if</span> fallback <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">26</span>                dest <span style="color: #666666">=</span> dest <span style="color: #AA22FF; font-weight: bold">or</span> (<span style="color: #008000">self</span><span style="color: #666666">.</span>basedir <span style="color: #666666">/</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>candidates[<span style="color: #666666">0</span>] <span style="color: #666666">/</span> path)
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">27</span>                dest<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">28</span>                dest<span style="color: #666666">.</span>write_text(fallback)
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">29</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">30</span>            <span style="color: #008000; font-weight: bold">return</span> dest<span style="color: #666666">.</span>read_text()
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">31</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">32</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">33</span>    <span style="color: #008000; font-weight: bold">return</span> Asset()
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">34</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">35</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">36</span><span style="color: #AA22FF">@pytest</span><span style="color: #666666">.</span>fixture(scope<span style="color: #666666">=</span><span style="color: #BA2121">"function"</span>)
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">37</span><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">fake_anki21</span>(monkeypatch):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">38</span>    <span style="color: #3D7B7B; font-style: italic"># monkey patch a fake anki21 module</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">39</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">40</span>    <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Anki</span>(types<span style="color: #666666">.</span>ModuleType):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">41</span>        version <span style="color: #666666">=</span> <span style="color: #BA2121">"23.10.1"</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">42</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">43</span>        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">pointVersion</span>(<span style="color: #008000">self</span>):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">44</span>            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>point_version()
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">45</span>        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">point_version</span>(<span style="color: #008000">self</span>):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">46</span>            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">231001</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">47</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">48</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">49</span>    <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AnkiHooks</span>(types<span style="color: #666666">.</span>ModuleType):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">50</span>        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">addHook</span>(<span style="color: #008000">self</span>):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">51</span>            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">999</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">52</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">53</span>    <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Aqt</span>(types<span style="color: #666666">.</span>ModuleType):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">54</span>        <span style="color: #008000; font-weight: bold">pass</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">55</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">56</span>    <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AqtMV</span>(types<span style="color: #666666">.</span>ModuleType):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">57</span>        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">callme</span>(<span style="color: #008000">self</span>):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">58</span>            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">123</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">59</span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">60</span>    replacements <span style="color: #666666">=</span> [
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">61</span>        (<span style="color: #BA2121">"anki"</span>, Anki),
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">62</span>        (<span style="color: #BA2121">"anki.hooks"</span>, AnkiHooks),
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">63</span>        (<span style="color: #BA2121">"aqt"</span>, Aqt),
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">64</span>        (<span style="color: #BA2121">"aqt.mw"</span>, AqtMV),
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">65</span>    ]
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">66</span>    old <span style="color: #666666">=</span> {}
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">67</span>    <span style="color: #008000; font-weight: bold">for</span> name, <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> replacements:
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">68</span>        old[name] <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>modules<span style="color: #666666">.</span>get(name)
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">69</span>        sys<span style="color: #666666">.</span>modules[name] <span style="color: #666666">=</span> <span style="color: #008000">cls</span>(name)
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">70</span>    <span style="color: #008000; font-weight: bold">yield</span> old
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">71</span>    <span style="color: #008000; font-weight: bold">for</span> name, mod <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">reversed</span>(old<span style="color: #666666">.</span>items()):
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">72</span>        <span style="color: #008000; font-weight: bold">if</span> mod:
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">73</span>            sys<span style="color: #666666">.</span>modules[name] <span style="color: #666666">=</span> mod
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">74</span>        <span style="color: #008000; font-weight: bold">else</span>:
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;">75</span>            <span style="color: #008000; font-weight: bold">del</span> sys<span style="color: #666666">.</span>modules[name]
</pre>
</div>
</div>